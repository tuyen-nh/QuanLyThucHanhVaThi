package com.example.agent.Security;

import ai.onnxruntime.OnnxTensor;
import ai.onnxruntime.OrtEnvironment;
import ai.onnxruntime.OrtSession;
import org.springframework.stereotype.Component;

import java.io.InputStream;
import java.nio.FloatBuffer;
import java.util.Collections;

@Component // Đánh dấu để Spring Boot quản lý (Dependency Injection)
public class MalwareScanner {

    private OrtEnvironment env;
    private OrtSession session;

    public MalwareScanner() {
        try {
            this.env = OrtEnvironment.getEnvironment();

            // Đọc file từ thư mục resources/models/
            InputStream modelStream = getClass().getResourceAsStream("/models/malware_rf.onnx");
            if (modelStream == null) {
                throw new RuntimeException("cannot find file model into resources folder!");
            }

            // Load model từ stream byte
            byte[] modelArray = modelStream.readAllBytes();
            this.session = env.createSession(modelArray, new OrtSession.SessionOptions());

            System.out.println("--- The model has been successfully loaded.---");

            // --- ADD THE INSPECTION CODE HERE ---
            System.out.println("=== Model Metadata ===");
            session.getInputNames().forEach(name -> {
                try {
                    System.out.println("Input Name: " + name);
                    System.out.println("Input Info: " + session.getInputInfo().get(name).toString());
                } catch (Exception e) {
                    e.printStackTrace();
                }
            });

            session.getOutputNames().forEach(name -> {
                try {
                    System.out.println("Output Name: " + name);
                    System.out.println("Output Info: " + session.getOutputInfo().get(name).toString());
                } catch (Exception e) {
                    e.printStackTrace();
                }
            });
            System.out.println("=======================");
        } catch (Exception e) {
            e.printStackTrace();
            System.err.println("Lỗi khởi tạo AI: " + e.getMessage());
        }
    }

    public boolean isMalware(float[] features) throws Exception {
        if (session == null)
            return false;

        long[] shape = new long[] { 1, features.length };
        OnnxTensor tensor = OnnxTensor.createTensor(env, FloatBuffer.wrap(features), shape);

        // Use the actual input name from the model if it's different
        String inputName;
        try {
            inputName = session.getInputNames().contains("float_input") ? "float_input"
                    : session.getInputNames().iterator().next();
        } catch (Exception ex) {
            inputName = "float_input"; // fallback
        }

        try (OrtSession.Result result = session.run(Collections.singletonMap(inputName, tensor))) {
            long[] labels = (long[]) result.get(0).getValue();
            return labels[0] == 0; // Giả sử 0 là Malware (kiểm tra lại Python của bạn)
        }
    }
}